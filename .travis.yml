language: php
sudo: required

services:
  - docker

php:
  - '7.1'

cache:
  directories:
        - $HOME/.composer/cache

git:
  depth: 1

env:
  global:
    - SERVICE_NAME=cogswell.lib.unb.ca
    - AMAZON_ECR_REGION=us-east-1
    - DEPLOY_BRANCHES=dev,prod
    - DEPLOYMENT_FINISHED_MARKER=99_report_as_complete
    - DOCKER_UPSTREAM_IMAGE=unblibraries/drupal:alpine-nginx-php7-8.x-composer
    - OLD_IMAGES_TO_KEEP=2
    - SERVICE_DEPLOY_PORT=80
    - SERVICE_TEST_UP_PATH=/user

before_install:
  - git clone git://github.com/unb-libraries/CargoDock.git CargoDock
  - CargoDock/travis/installDockerCompose.sh
  - CargoDock/aws/installAuthAws.sh
  - cp docker-compose.yml.travis docker-compose.yml
  - CargoDock/travis/setDockerComposeEnv.sh

before_script:
  - CargoDock/travis/buildInstanceTheme.sh
  - CargoDock/travis/buildInstanceForTesting.sh
  - CargoDock/travis/waitForDeploy.sh
  - CargoDock/travis/checkStartupForErrors.sh

script:
  - CargoDock/travis/testInstance.sh

after_success:
  - CargoDock/travis/buildImagePushToRepo.sh
  - CargoDock/travis/cleanupOldImages.sh
  - CargoDock/travis/triggerKubeDeploy.sh

notifications:
  slack:
    rooms:
      secure: YW0kOjJbCQAqpjeQ5IA7uEHTfjenAgX9NArSNaQoWanuCAjZqtXymwJ9TziypEbGyi7ATkXzKFPTNK+kA2vehRtI67tD3EOPo8aFarKfqOnnvF2TqQclVmAL2gQfuvX9Ytagdl1zJLhOOA/Jt7v8E3WsD3V6mzZhrk+J4nme93WOB1Wpy5CnrA4kegG4Hb9ldf8KwNfunXMAp23P7wk/Ya6JgE/vwYOHPk9huWPWSYIEevk5HEq3ShKE5g4QKqUyF8rYAFYVErzpHd7P8fUEnfh5x+OnCtXdYxMDyrbMCFWqY1If8rcXo8q3CWrFK+FLJJ8WbPjhz7xE0A5tVGUzt92F2y9iusbILS3mvI9COFCSSPZcbraMHa2IvU4PPr9p8tYyi3pAgPr+XIrg9914lzic22wIEch9j08kxreHYN5fgY8uO3aoCB0rri+Qo/0hwm3gwxGuBz8rnwloQLqpSYcXwl3z7gPGvO/uzeV+6roWYUtA/3+r0VolZf3RJtbvO/6e4YVS3imkeUQRFDjKI/9KgnV97/eDylprFIc+pXCv0XsWOva+zx2Z6kih47ne98G4cT5wvLqAA4cVTupCZzzt39CVBOjvRz843/7ON3eG1xQJWdpgt3g56oBClCYtMYInvIWlNohJ13QRCNVmWvepzn0SPceK4Aa5CBw7J1M=
    on_start: always
    on_success: always
